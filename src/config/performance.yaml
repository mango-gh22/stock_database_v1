# File: config/performance.yaml
# Desc: 性能优化与监控配置

# 并行计算配置
parallel_computing:
  enabled: true
  mode: "thread"  # thread, process, async
  max_workers: 4
  timeout: 300
  batch_size: 10

  # 策略选择
  strategy:
    data_threshold: 1000  # 数据行数阈值，超过此值启用并行
    complexity_threshold: "medium"  # 复杂度阈值：low, medium, high
    auto_adjust: true  # 自动调整工作线程数
    min_workers: 1
    max_workers: 8
    adaptive: true  # 自适应调整

# 缓存配置
caching:
  enabled: true
  multi_level: true
  cache_root: "data/cache/performance"

  # 内存缓存 (L1)
  memory_cache:
    enabled: true
    strategy: "lru"  # lru, lfu, arc, ttl, fifo
    max_size: 100  # MB
    default_ttl: 3600  # 秒
    max_items: 1000
    cleanup_interval: 60  # 清理间隔（秒）

  # 磁盘缓存 (L2)
  disk_cache:
    enabled: true
    strategy: "lfu"
    max_size: 1000  # MB
    cache_dir: "data/cache/disk"
    compression: true
    compression_level: 6
    serialize_format: "pickle"  # pickle, json, msgpack

  # 缓存组管理
  groups:
    enabled: true
    auto_cleanup: true
    cleanup_interval: 3600
    max_groups: 50
    group_ttl: 86400  # 组级TTL（秒）

# 内存管理配置
memory_management:
  monitoring:
    enabled: true
    interval: 5  # 秒
    history_size: 1000
    track_types: true  # 跟踪对象类型
    track_leaks: true  # 跟踪内存泄漏

  # 内存阈值 (百分比)
  thresholds:
    low: 60
    medium: 80
    high: 90
    critical: 95

  # 优化策略
  optimization:
    auto_optimize: true
    df_optimization: true
    array_compression: true
    cleanup_interval: 300
    gc_enabled: true  # 启用垃圾回收
    gc_threshold: 85  # GC触发阈值

  # 泄漏检测
  leak_detection:
    enabled: true
    interval: 60  # 检测间隔（秒）
    threshold_mb: 10  # 内存增长阈值（MB）
    snapshot_count: 5  # 快照数量
    track_growth: true  # 跟踪内存增长

# 监控配置
monitoring:
  enabled: true
  log_level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  log_retention: 30  # 日志保留天数

  # 性能监控
  performance:
    enabled: true
    interval: 10  # 采集间隔（秒）
    metrics:
      - "cpu_usage"
      - "memory_usage"
      - "disk_io"
      - "network_io"
      - "cache_hit_rate"
      - "query_latency"
      - "parallel_efficiency"

  # 指标验证
  validation:
    enabled: true
    validate_on_calc: true  # 计算时验证
    validate_on_query: true  # 查询时验证
    tolerance: 0.001  # 容差
    max_history: 100  # 历史记录最大数量

  # 计算日志
  calculation_log:
    enabled: true
    log_level: "DEBUG"
    log_queries: true
    log_results: false  # 谨慎启用，可能包含敏感数据
    log_performance: true
    max_log_size: 100  # MB

# 警报配置
alerts:
  enabled: true
  channels: ["log", "file"]  # log, file, email, webhook

  thresholds:
    cpu_usage: 90  # %
    memory_usage: 85  # %
    disk_usage: 80  # %
    query_timeout: 30  # 秒
    error_rate: 5  # %

  # 通知配置
  notification:
    email:
      enabled: false
      smtp_server: "smtp.example.com"
      smtp_port: 587
      sender: "alerts@example.com"
      receivers:
        - "admin@example.com"

    webhook:
      enabled: false
      url: "https://hooks.example.com/alert"
      timeout: 10

# 测试与基准配置
benchmark:
  enabled: true
  test_cases:
    - name: "small_dataset"
      size: 1000
      workers: [1, 2, 4]

    - name: "medium_dataset"
      size: 10000
      workers: [1, 2, 4, 8]

    - name: "large_dataset"
      size: 100000
      workers: [1, 2, 4, 8]

  # 基准测试频率
  schedule: "weekly"  # daily, weekly, monthly
  run_on_startup: false