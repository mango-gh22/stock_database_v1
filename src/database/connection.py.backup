# _*_ coding: utf-8 _*_
# File Path: E:/MyFile/stock_database_v1/src\connection.py
# File Name: connection
# @ File: connection.py
# @ Author: mango-gh22
# @ PyCharm
# @ Date：2025/12/4 23:59
"""
desc 创建数据库连接模块
"""
import yaml
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, scoped_session
from sqlalchemy.ext.declarative import declarative_base
from src.utils.logger import get_logger

logger = get_logger(__name__)


def load_database_config():
    """加载数据库配置文件"""
    try:
        with open('config/database.yaml', 'r', encoding='utf-8') as f:
            config = yaml.safe_load(f)
        return config['database']['mysql']
    except FileNotFoundError:
        logger.error("数据库配置文件 config/database.yaml 不存在")
        raise
    except KeyError:
        logger.error("配置文件格式错误，缺少 database.mysql 配置项")
        raise


def create_database_engine():
    """创建数据库引擎"""
    config = load_database_config()

    # 构建数据库连接URL
    db_url = (
        f"mysql+pymysql://{config['user']}:{config['password']}"
        f"@{config['host']}:{config['port']}/{config['database']}"
        f"?charset={config['charset']}"
    )

    logger.info(f"正在连接数据库: {config['database']}@{config['host']}")
    engine = create_engine(db_url, pool_recycle=3600)
    return engine


# 全局数据库引擎和会话工厂
engine = create_database_engine()
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)


def get_session():
    """获取数据库会话（用于P2及以后阶段）"""
    return SessionLocal()


def test_connection():
    """测试数据库连接（P1阶段用）"""
    try:
        with engine.connect() as conn:
            conn.execute("SELECT 1")
        logger.info("数据库连接测试成功！")
        return True
    except Exception as e:
        logger.error(f"数据库连接失败: {e}")
        return False


def get_connection():
    """
    获取数据库连接（兼容P4需求）

    注意：这里返回的是SQLAlchemy引擎，而不是pymysql连接
    """
    return engine


def get_pymysql_connection():
    """
    获取pymysql连接（如果需要的话）
    """
    import pymysql
    config = load_database_config()
    return pymysql.connect(
        host=config['host'],
        port=config['port'],
        user=config['user'],
        password=config['password'],
        database=config['database'],
        charset=config['charset']
    )
